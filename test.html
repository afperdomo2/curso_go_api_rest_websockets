<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Posts - REST API con WebSockets</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .status {
        padding: 20px;
        border-bottom: 1px solid #eee;
      }

      .status-item {
        display: inline-block;
        margin-right: 20px;
        padding: 10px 15px;
        border-radius: 20px;
        font-weight: bold;
        color: white;
      }

      .status-connected {
        background: #28a745;
      }

      .status-disconnected {
        background: #dc3545;
      }

      .status-loading {
        background: #ffc107;
        color: #333;
      }

      .controls {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }

      .posts-container {
        padding: 20px;
      }

      .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .post-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
      }

      .post-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .post-id {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #667eea;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .post-content {
        margin-bottom: 15px;
        font-size: 1.1em;
        line-height: 1.6;
        color: #333;
      }

      .post-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #eee;
        font-size: 0.9em;
        color: #666;
      }

      .post-user {
        font-weight: bold;
        color: #667eea;
      }

      .post-date {
        color: #999;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #f5c6cb;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
      }

      .websocket-messages {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
      }

      .websocket-message {
        padding: 8px;
        margin: 5px 0;
        background: white;
        border-radius: 5px;
        border-left: 4px solid #667eea;
        font-size: 0.9em;
      }

      @media (max-width: 768px) {
        .posts-grid {
          grid-template-columns: 1fr;
        }

        .controls {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìù Posts Dashboard</h1>
        <p>REST API con WebSockets en tiempo real</p>
      </div>

      <div class="status">
        <span id="apiStatus" class="status-item status-loading"
          >API: Conectando...</span
        >
        <span id="wsStatus" class="status-item status-loading"
          >WebSocket: Conectando...</span
        >
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="loadPosts()">
          üîÑ Recargar Posts
        </button>
        <button class="btn btn-secondary" onclick="connectWebSocket()">
          üîå Reconectar WS
        </button>
        <button class="btn btn-secondary" onclick="clearMessages()">
          üóëÔ∏è Limpiar Mensajes
        </button>
      </div>

      <div class="posts-container">
        <h2>üìã Lista de Posts</h2>
        <div id="error-container"></div>
        <div id="posts-container" class="loading">
          <p>Cargando posts...</p>
        </div>

        <h3 style="margin-top: 30px">üì° Mensajes WebSocket</h3>
        <div id="websocket-messages" class="websocket-messages">
          <p style="color: #666; font-style: italic">
            Los mensajes del WebSocket aparecer√°n aqu√≠...
          </p>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let posts = [];

      // Configuraci√≥n
      const API_BASE_URL = "http://localhost:5050/api/v1";
      const WS_URL = "ws://localhost:5050/ws";

      // Elementos del DOM
      const postsContainer = document.getElementById("posts-container");
      const errorContainer = document.getElementById("error-container");
      const apiStatus = document.getElementById("apiStatus");
      const wsStatus = document.getElementById("wsStatus");
      const wsMessages = document.getElementById("websocket-messages");

      // Inicializar la aplicaci√≥n
      document.addEventListener("DOMContentLoaded", function () {
        loadPosts();
        connectWebSocket();
      });

      // Funci√≥n para cargar posts desde la API
      async function loadPosts() {
        try {
          showLoading();
          clearError();

          const response = await fetch(`${API_BASE_URL}/posts`);

          if (!response.ok) {
            throw new Error(
              `Error HTTP: ${response.status} - ${response.statusText}`
            );
          }

          const data = await response.json();
          posts = data || [];

          updateApiStatus(true);
          renderPosts();
        } catch (error) {
          console.error("Error cargando posts:", error);
          updateApiStatus(false);
          showError(`Error al cargar posts: ${error.message}`);
          renderEmptyState();
        }
      }

      // Funci√≥n para renderizar los posts
      function renderPosts() {
        if (posts.length === 0) {
          renderEmptyState();
          return;
        }

        const postsHtml = posts
          .map(
            (post) => `
                <div class="post-card">
                    <div class="post-id">#${post.id}</div>
                    <h3 class="post-title">${escapeHtml(post.title)}</h3>
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    <div class="post-meta">
                        <span class="post-user">üë§ Usuario: ${
                          post.user_id
                        }</span>
                        <span class="post-date">üìÖ ${formatDate(
                          post.created_at
                        )}</span>
                    </div>
                </div>
            `
          )
          .join("");

        postsContainer.innerHTML = `
                <div class="posts-grid">
                    ${postsHtml}
                </div>
            `;
      }

      // Funci√≥n para mostrar estado vac√≠o
      function renderEmptyState() {
        postsContainer.innerHTML = `
                <div class="empty-state">
                    <h3>üì≠ No hay posts disponibles</h3>
                    <p>A√∫n no se han creado posts o no se pudieron cargar.</p>
                </div>
            `;
      }

      // Funci√≥n para mostrar loading
      function showLoading() {
        postsContainer.innerHTML = `
                <div class="loading">
                    <p>üîÑ Cargando posts...</p>
                </div>
            `;
      }

      // Funci√≥n para conectar WebSocket
      function connectWebSocket() {
        try {
          if (ws) {
            ws.close();
          }

          ws = new WebSocket(WS_URL);

          ws.onopen = function () {
            console.log("WebSocket conectado");
            updateWsStatus(true);
            addWebSocketMessage("‚úÖ Conectado al WebSocket", "success");
          };

          ws.onmessage = function (event) {
            console.log("Mensaje recibido:", event.data);
            addWebSocketMessage(`üì® ${event.data}`, "message");

            // Si el mensaje indica un nuevo post, recargar la lista
            try {
              const message = JSON.parse(event.data);
              if (
                message.type === "post_created" ||
                message.type === "post_updated" ||
                message.type === "post_deleted"
              ) {
                loadPosts();
              }
            } catch (e) {
              // El mensaje no es JSON, ignorar
            }
          };

          ws.onclose = function () {
            console.log("WebSocket desconectado");
            updateWsStatus(false);
            addWebSocketMessage("‚ùå WebSocket desconectado", "error");
          };

          ws.onerror = function (error) {
            console.error("Error WebSocket:", error);
            updateWsStatus(false);
            addWebSocketMessage(
              `‚ùå Error: ${error.message || "Error desconocido"}`,
              "error"
            );
          };
        } catch (error) {
          console.error("Error conectando WebSocket:", error);
          updateWsStatus(false);
          addWebSocketMessage(
            `‚ùå Error al conectar: ${error.message}`,
            "error"
          );
        }
      }

      // Funci√≥n para agregar mensajes del WebSocket
      function addWebSocketMessage(message, type = "info") {
        const messageElement = document.createElement("div");
        messageElement.className = "websocket-message";
        messageElement.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;

        if (
          wsMessages.children.length === 1 &&
          wsMessages.children[0].style.fontStyle === "italic"
        ) {
          wsMessages.innerHTML = "";
        }

        wsMessages.appendChild(messageElement);
        wsMessages.scrollTop = wsMessages.scrollHeight;
      }

      // Funci√≥n para limpiar mensajes
      function clearMessages() {
        wsMessages.innerHTML =
          '<p style="color: #666; font-style: italic;">Los mensajes del WebSocket aparecer√°n aqu√≠...</p>';
      }

      // Funci√≥n para actualizar estado de la API
      function updateApiStatus(connected) {
        if (connected) {
          apiStatus.textContent = "API: Conectada ‚úÖ";
          apiStatus.className = "status-item status-connected";
        } else {
          apiStatus.textContent = "API: Error ‚ùå";
          apiStatus.className = "status-item status-disconnected";
        }
      }

      // Funci√≥n para actualizar estado del WebSocket
      function updateWsStatus(connected) {
        if (connected) {
          wsStatus.textContent = "WebSocket: Conectado ‚úÖ";
          wsStatus.className = "status-item status-connected";
        } else {
          wsStatus.textContent = "WebSocket: Desconectado ‚ùå";
          wsStatus.className = "status-item status-disconnected";
        }
      }

      // Funci√≥n para mostrar errores
      function showError(message) {
        errorContainer.innerHTML = `
                <div class="error">
                    <strong>‚ùå Error:</strong> ${message}
                </div>
            `;
      }

      // Funci√≥n para limpiar errores
      function clearError() {
        errorContainer.innerHTML = "";
      }

      // Funci√≥n para escapar HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Funci√≥n para formatear fecha
      function formatDate(dateString) {
        const date = new Date(dateString);
        return (
          date.toLocaleDateString("es-ES") +
          " " +
          date.toLocaleTimeString("es-ES")
        );
      }

      // Cerrar WebSocket al cerrar la p√°gina
      window.addEventListener("beforeunload", function () {
        if (ws) {
          ws.close();
        }
      });
    </script>
  </body>
</html>
